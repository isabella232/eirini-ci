#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ load("/namespaces.star", "system_namespace", "workloads_namespace")

#@overlay/match by=overlay.subset({"kind": "Gateway", "metadata":{"name": "istio-ingressgateway"}})
---
spec:
  servers:
  #@overlay/append
  - hosts:
    - #@ workloads_namespace() + '/eirini.cf'
    port:
      name: eirinidotcf-workload
      number: 443
      protocol: HTTPS
    tls:
      credentialName: eirinidotcf-cert
      mode: SIMPLE
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: eirinidotcf-cert
  namespace: #@ system_namespace()
spec:
  secretName: eirinidotcf-cert
  commonName: eirini.cf
  dnsNames:
  - eirini.cf
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  namespace: #@ system_namespace()
spec:
  acme:
    # You must replace this email address with your own.
    # Let's Encrypt will use this to contact you about expiring
    # certificates, and issues related to your account.
    email: eirini@cloudfoundry.org
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Secret resource that will be used to store the account's private key.
      name: eirinidotcf-cert
    # Add a single challenge solver, HTTP01 using nginx
    solvers:
    - http01:
        ingress:
          class: istio
